name: Flasher

on:
  workflow_dispatch:
  release:
    types: [published]
    
jobs:
  download-and-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Download files
      run: |
        mkdir -p downloads
        cd downloads
        wget -O ArduinoDroid.apk --no-check-certificate https://fs20.uploadrar.com:183/d/mxsrw4tgamubi775iwh7d2ohq6thrrzu6ekhdmow527kvvbd2w3hihowdgqrhk3mfcvk4ikk/ArduinoDroid-Arduino-ESPIDEv7.0.1b715arm648.0_edbyyouarefinished-a2zapk.io.apk
        wget -O ESPFlash.xapk "https://d-03.winudf.com/b/XAPK/aW8uc2VyaWFsZmxvdy5lc3BmbGFzaF8yN19jMGNlNjFkZg?_fn=RVNQRmxhc2hfMS4xLjVfQVBLUHVyZS54YXBr&_p=aW8uc2VyaWFsZmxvdy5lc3BmbGFzaA%3D%3D&download_id=1491508313790002&is_hot=false&k=c89407d93bed0fab234063a36837ba16692aa704"
        wget -O ESP32_Flasher.xapk "https://d-06.winudf.com/b/XAPK/Y29tLmVzcF9mbGFzaC5lc3BfZmxhc2hfYXBwXzQ5X2RkYTEyN2M1?_fn=RVNQMzJfRmxhc2hlcl80LjAuOV9BUEtQdXJlLnhhcGs&_p=Y29tLmVzcF9mbGFzaC5lc3BfZmxhc2hfYXBw&download_id=otr_1807606449811121&is_hot=false&k=6cd717b0e62959f1fc459472b92b34e8692aa97d"
        wget -O ESP8266_Loader.apk "https://d-12.winudf.com/b/APK/Y29tLmJsdWluby5lc3Bsb2FkZXJfMTdfZjEzODk1MTk?_fn=RVNQODI2NiBMb2FkZXIgKEJseW5rIFVwbG9hZGVyXzEuNF9BUEtQdXJlLmFwaw&_p=Y29tLmJsdWluby5lc3Bsb2FkZXI%3D&download_id=1123708034116151&is_hot=false&k=e51049c1ad76e700fa7f1f86ca7fed55692aaa2a"

    - name: Determine release tag
      id: get_tag
      run: |
        if [ "${{ github.event_name }}" == "release" ]; then
          TAG_NAME="${{ github.event.release.tag_name }}"
        else
          TAG_NAME="Apps"
        fi
        echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT

    - name: Delete existing release assets
      uses: actions/github-script@v7
      with:
        script: |
          const { data: releases } = await github.rest.repos.listReleases({
            owner: context.repo.owner,
            repo: context.repo.repo
          });
          
          const targetRelease = releases.find(release => release.tag_name === '${{ steps.get_tag.outputs.tag_name }}');
          
          if (targetRelease) {
            console.log(`Found release with tag: ${{ steps.get_tag.outputs.tag_name }}`);
            console.log(`Release ID: ${targetRelease.id}`);
            
            const { data: assets } = await github.rest.repos.listReleaseAssets({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: targetRelease.id
            });
            
            console.log(`Found ${assets.length} assets to delete`);
            
            for (const asset of assets) {
              console.log(`Deleting asset: ${asset.name} (ID: ${asset.id})`);
              await github.rest.repos.deleteReleaseAsset({
                owner: context.repo.owner,
                repo: context.repo.repo,
                asset_id: asset.id
              });
            }
            
            console.log('All existing assets deleted');
          } else {
            console.log(`No release found with tag: ${{ steps.get_tag.outputs.tag_name }}`);
          }
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload files to existing release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.get_tag.outputs.tag_name }}
        files: |
            downloads/*.*
            
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
